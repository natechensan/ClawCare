# ClawCare Default Ruleset — Command / Permission / Secrets
#
# Severity criteria:
#   critical — Direct, unmediated harm: arbitrary code execution from
#              untrusted input, credential theft, persistence mechanisms,
#              or irreversible data destruction. Attacker gains immediate
#              control or access with no user interaction required.
#   high     — Enables attacks but requires additional context or chaining:
#              reverse shells, raw-IP C2 channels, exfiltration patterns
#              that combine secrets + outbound calls.
#   medium   — Risky patterns with legitimate uses: shell=True, eval(),
#              runtime package installs. Dangerous in untrusted code but
#              common in build scripts and dev tooling.
#   low      — Code smells that weaken security posture but aren't directly
#              exploitable: overly broad permissions, wide file globs.
#
# CWE references are included where the mapping is accurate.
# See https://cwe.mitre.org/data/definitions/<ID>.html

# ── Critical ────────────────────────────────────────────────

- id: CRIT_PIPE_TO_SHELL
  severity: critical
  pattern: "(curl|wget)\\s+[^\\n|]*\\|\\s*(bash|sh|zsh|python[23]?|node)"
  explanation: Piping remote content directly into a shell interpreter is a classic supply-chain attack vector.
  remediation: Download first, inspect, then execute.
  # CWE-78: Improper Neutralization of Special Elements used in an OS Command

- id: CRIT_POWERSHELL_ENCODED
  severity: critical
  pattern: "powershell\\s+.*-[eE](?:nc(?:oded)?[cC](?:ommand)?)\\s"
  explanation: PowerShell encoded commands hide payload intent.
  remediation: Use plain-text scripts instead of encoded commands.
  # CWE-78: OS Command Injection
  # CWE-116: Improper Encoding or Escaping of Output

- id: CRIT_POWERSHELL_IEX
  severity: critical
  pattern: "(?:iex|Invoke-Expression)\\s*[\\(\\s]"
  explanation: Invoke-Expression can execute arbitrary code.
  remediation: Avoid iex / Invoke-Expression.
  # CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code

- id: CRIT_BASE64_EXEC
  severity: critical
  pattern: "base64\\s+(-d|--decode)[^\\n|]*\\|\\s*(bash|sh|zsh|python[23]?|node|perl)"
  explanation: Base64-decoded content piped to an interpreter hides the real payload.
  remediation: Decode and inspect the content before execution.
  # CWE-78: OS Command Injection
  # CWE-506: Embedded Malicious Code

- id: CRIT_CREDENTIAL_PATH
  severity: critical
  pattern: "(~/\\.ssh/|id_rsa|id_ed25519|\\.pem\\b|~/\\.aws/credentials|~/\\.kube/config|security\\s+find-generic-password|security\\s+find-internet-password)"
  explanation: Accessing well-known credential paths or keychain commands.
  remediation: Avoid accessing credential paths directly; use a secrets manager.
  # CWE-522: Insufficiently Protected Credentials

- id: CRIT_PERSISTENCE
  severity: critical
  pattern: "(crontab\\s+-|/etc/cron|systemctl\\s+(enable|start)|LaunchAgents|LaunchDaemons|launchctl\\s+(load|submit))"
  explanation: Setting up persistence mechanisms (cron, systemd, LaunchAgents) can allow long-running malicious processes.
  remediation: Remove persistence setup or document it in the policy manifest.
  # CWE-506: Embedded Malicious Code

- id: CRIT_DESTRUCTIVE
  severity: critical
  pattern: "(rm\\s+-r[f ]|rm\\s+-fr\\b|mkfs\\.|format\\s+[A-Za-z]:|diskutil\\s+erase)"
  explanation: Destructive filesystem operations can cause data loss.
  remediation: Avoid destructive operations in extension code.

# ── High ────────────────────────────────────────────────────

- id: HIGH_REVERSE_SHELL
  severity: high
  pattern: "(/dev/tcp/|nc\\s+.*-e\\s|ncat\\s+.*-e\\s|bash\\s+-i\\s+>&|python[23]?\\s+-c\\s+.*socket.*connect)"
  explanation: Reverse shell patterns allow remote command execution.
  remediation: Remove reverse shell code; this should never appear in extensions.
  # CWE-506: Embedded Malicious Code

- id: HIGH_RAW_IP_OUTBOUND
  severity: high
  pattern: "(https?://\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})"
  explanation: Outbound connections to raw IP addresses bypass DNS oversight.
  remediation: Use domain names instead of raw IP addresses.
  # CWE-941: Incorrectly Specified Destination in a Communication Channel

- id: HIGH_SECRET_EXFIL
  severity: high
  pattern: "(API_KEY|SECRET_KEY|ACCESS_TOKEN|PRIVATE_KEY|PASSWORD)[^\\n]{0,80}(POST|fetch|requests\\.post|curl\\s+-X\\s*POST|curl\\s+--data)"
  explanation: Secret environment variable referenced near an outbound POST call suggests credential exfiltration.
  remediation: Avoid sending secrets over the network in extension code.
  # CWE-200: Exposure of Sensitive Information to an Unauthorized Actor

# ── Medium ──────────────────────────────────────────────────

- id: MED_SUBPROCESS_SHELL
  severity: medium
  pattern: "subprocess\\.\\w+\\([^)]*shell\\s*=\\s*True"
  explanation: subprocess with shell=True can execute arbitrary shell commands.
  remediation: Use subprocess with shell=False and pass args as a list.
  # CWE-78: OS Command Injection

- id: MED_JS_EVAL
  severity: medium
  pattern: "\\b(eval|Function)\\s*\\("
  explanation: eval() or Function() can execute arbitrary code at runtime.
  remediation: Avoid eval/Function; use safer alternatives.
  # CWE-95: Eval Injection

- id: MED_RUNTIME_INSTALL
  severity: medium
  pattern: "(pip\\s+install\\s|npm\\s+install\\s|yarn\\s+add\\s|gem\\s+install\\s)"
  explanation: Installing packages at runtime in an extension script is risky unless pinned to exact versions with a lockfile.
  remediation: Pin dependencies and use a lockfile.
  # CWE-829: Inclusion of Functionality from Untrusted Control Sphere

# ── Low ─────────────────────────────────────────────────────

- id: LOW_BROAD_PERMISSIONS
  severity: low
  pattern: "(chmod\\s+777|chmod\\s+a\\+rwx|chmod\\s+-R\\s+777)"
  explanation: Overly broad file permissions may expose sensitive files.
  remediation: Use least-privilege permissions (e.g. 755 or 644).
  # CWE-732: Incorrect Permission Assignment for Critical Resource

- id: LOW_BROAD_GLOB
  severity: low
  pattern: "(glob\\.\\w+\\(\\s*['\"][*/]|readdir\\w*\\(\\s*['\"]/)"
  explanation: Reading files with overly broad globs may access unintended data.
  remediation: Narrow the file glob pattern to specific directories.
